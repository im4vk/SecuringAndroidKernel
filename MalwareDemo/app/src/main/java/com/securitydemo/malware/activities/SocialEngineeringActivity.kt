package com.securitydemo.malware.activities

import android.app.AlertDialog
import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.provider.Settings
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.securitydemo.malware.R
import com.securitydemo.malware.utils.SocialEngineeringManager
import kotlinx.coroutines.*

/**
 * SECURITY DEMO: Social Engineering Activity
 * 
 * This activity demonstrates psychological manipulation techniques used by malware:
 * - Fake system dialogs and security warnings
 * - Deceptive permission requests
 * - Urgency and fear-based manipulation
 * - Authority impersonation (system/security)
 * - Fake update and maintenance notifications
 * - User interface spoofing and mimicry
 * 
 * EDUCATIONAL PURPOSE ONLY - Shows real social engineering methods
 */
class SocialEngineeringActivity : AppCompatActivity() {

    private lateinit var statusTextView: TextView
    private lateinit var fakeSecurityWarningButton: Button
    private lateinit var fakeSystemUpdateButton: Button
    private lateinit var fakePermissionRequestButton: Button
    private lateinit var phishingAttackButton: Button
    private lateinit var urgencyManipulationButton: Button
    private lateinit var authorityImpersonationButton: Button

    private lateinit var socialEngineeringManager: SocialEngineeringManager
    private val activityScope = CoroutineScope(Dispatchers.Main + SupervisorJob())

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_social_engineering)

        initializeViews()
        socialEngineeringManager = SocialEngineeringManager(this)
        
        showSocialEngineeringWarning()
        updateStatus("üé≠ Social Engineering Demo Ready\n")
        updateStatus("‚ö†Ô∏è These techniques are used to manipulate users psychologically\n")
    }

    private fun initializeViews() {
        statusTextView = findViewById(R.id.tv_social_engineering_status)
        fakeSecurityWarningButton = findViewById(R.id.btn_fake_security_warning)
        fakeSystemUpdateButton = findViewById(R.id.btn_fake_system_update)
        fakePermissionRequestButton = findViewById(R.id.btn_fake_permission_request)
        phishingAttackButton = findViewById(R.id.btn_phishing_attack)
        urgencyManipulationButton = findViewById(R.id.btn_urgency_manipulation)
        authorityImpersonationButton = findViewById(R.id.btn_authority_impersonation)

        fakeSecurityWarningButton.setOnClickListener { demonstrateFakeSecurityWarning() }
        fakeSystemUpdateButton.setOnClickListener { demonstrateFakeSystemUpdate() }
        fakePermissionRequestButton.setOnClickListener { demonstrateFakePermissionRequest() }
        phishingAttackButton.setOnClickListener { demonstratePhishingAttack() }
        urgencyManipulationButton.setOnClickListener { demonstrateUrgencyManipulation() }
        authorityImpersonationButton.setOnClickListener { demonstrateAuthorityImpersonation() }
    }

    private fun showSocialEngineeringWarning() {
        AlertDialog.Builder(this)
            .setTitle("‚ö†Ô∏è Social Engineering Demo")
            .setMessage("""
                This demonstrates psychological manipulation techniques:
                
                üé≠ SOCIAL ENGINEERING TACTICS:
                ‚Ä¢ Fake security warnings and alerts
                ‚Ä¢ Deceptive system notifications
                ‚Ä¢ Authority impersonation (system/security)
                ‚Ä¢ Urgency and fear-based manipulation
                ‚Ä¢ Fake permission justifications
                ‚Ä¢ User interface spoofing
                
                üéØ ATTACK OBJECTIVES:
                ‚Ä¢ Trick users into granting permissions
                ‚Ä¢ Manipulate users into installing malware
                ‚Ä¢ Create false sense of urgency
                ‚Ä¢ Bypass user security awareness
                ‚Ä¢ Exploit trust in system authorities
                
                üí° EDUCATIONAL PURPOSE:
                Learn to recognize these manipulation techniques!
                
                ‚ö†Ô∏è This is for educational purposes only!
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun demonstrateFakeSecurityWarning() {
        updateStatus("üö® DEMONSTRATING FAKE SECURITY WARNING...\n")
        
        activityScope.launch {
            updateStatus("Creating convincing fake security alert...")
            delay(1000)
            
            // Show fake security warning that looks like a real system dialog
            socialEngineeringManager.showFakeSecurityWarning { granted ->
                if (granted) {
                    updateStatus("‚úÖ User fell for fake security warning!")
                    updateStatus("üéØ Social engineering successful - user granted permissions")
                    updateStatus("üíÄ In real attack: Malware would now have elevated access\n")
                    
                    showSocialEngineeringSuccess("Security Warning", 
                        "User believed fake virus alert and granted permissions")
                } else {
                    updateStatus("‚ùå User rejected fake security warning")
                    updateStatus("üõ°Ô∏è User security awareness prevented attack\n")
                }
            }
        }
    }

    private fun demonstrateFakeSystemUpdate() {
        updateStatus("üì± DEMONSTRATING FAKE SYSTEM UPDATE...\n")
        
        activityScope.launch {
            updateStatus("Crafting convincing system update notification...")
            delay(1000)
            
            socialEngineeringManager.showFakeSystemUpdate { granted ->
                if (granted) {
                    updateStatus("‚úÖ User fell for fake system update!")
                    updateStatus("üéØ Social engineering successful - user believes system needs update")
                    updateStatus("üíÄ In real attack: Malware would be installed as 'system update'\n")
                    
                    showSocialEngineeringSuccess("System Update", 
                        "User believed fake update notification and approved installation")
                } else {
                    updateStatus("‚ùå User rejected fake system update")
                    updateStatus("üõ°Ô∏è User was suspicious of unauthorized update request\n")
                }
            }
        }
    }

    private fun demonstrateFakePermissionRequest() {
        updateStatus("üîì DEMONSTRATING FAKE PERMISSION REQUEST...\n")
        
        activityScope.launch {
            updateStatus("Creating deceptive permission justification...")
            delay(1000)
            
            socialEngineeringManager.showFakePermissionRequest { granted ->
                if (granted) {
                    updateStatus("‚úÖ User fell for fake permission justification!")
                    updateStatus("üéØ Social engineering successful - user granted dangerous permissions")
                    updateStatus("üíÄ In real attack: Malware would now have extensive device access\n")
                    
                    showSocialEngineeringSuccess("Permission Request", 
                        "User granted permissions based on false justification")
                } else {
                    updateStatus("‚ùå User rejected deceptive permission request")
                    updateStatus("üõ°Ô∏è User questioned permission justification\n")
                }
            }
        }
    }

    private fun demonstratePhishingAttack() {
        updateStatus("üé£ DEMONSTRATING PHISHING ATTACK...\n")
        
        activityScope.launch {
            updateStatus("Launching credential harvesting attack...")
            delay(1000)
            
            socialEngineeringManager.showPhishingDialog { credentialsEntered ->
                if (credentialsEntered) {
                    updateStatus("‚úÖ User fell for phishing attack!")
                    updateStatus("üéØ Social engineering successful - user entered credentials")
                    updateStatus("üíÄ In real attack: Login credentials would be stolen\n")
                    
                    showSocialEngineeringSuccess("Phishing Attack", 
                        "User entered credentials in fake login dialog")
                } else {
                    updateStatus("‚ùå User avoided phishing trap")
                    updateStatus("üõ°Ô∏è User recognized suspicious login request\n")
                }
            }
        }
    }

    private fun demonstrateUrgencyManipulation() {
        updateStatus("‚è∞ DEMONSTRATING URGENCY MANIPULATION...\n")
        
        activityScope.launch {
            updateStatus("Creating false sense of urgency...")
            delay(1000)
            
            socialEngineeringManager.showUrgencyManipulation { acted ->
                if (acted) {
                    updateStatus("‚úÖ User fell for urgency manipulation!")
                    updateStatus("üéØ Social engineering successful - user acted under pressure")
                    updateStatus("üíÄ In real attack: User bypassed normal security checks\n")
                    
                    showSocialEngineeringSuccess("Urgency Manipulation", 
                        "User made hasty decision due to artificial time pressure")
                } else {
                    updateStatus("‚ùå User resisted urgency pressure")
                    updateStatus("üõ°Ô∏è User took time to think before acting\n")
                }
            }
        }
    }

    private fun demonstrateAuthorityImpersonation() {
        updateStatus("üëÆ DEMONSTRATING AUTHORITY IMPERSONATION...\n")
        
        activityScope.launch {
            updateStatus("Impersonating trusted authority...")
            delay(1000)
            
            socialEngineeringManager.showAuthorityImpersonation { complied ->
                if (complied) {
                    updateStatus("‚úÖ User fell for authority impersonation!")
                    updateStatus("üéØ Social engineering successful - user trusted fake authority")
                    updateStatus("üíÄ In real attack: User would follow malicious instructions\n")
                    
                    showSocialEngineeringSuccess("Authority Impersonation", 
                        "User complied with request from fake authority figure")
                } else {
                    updateStatus("‚ùå User questioned authority request")
                    updateStatus("üõ°Ô∏è User verified authority before complying\n")
                }
            }
        }
    }

    private fun showSocialEngineeringSuccess(attackType: String, description: String) {
        AlertDialog.Builder(this)
            .setTitle("üéØ SOCIAL ENGINEERING SUCCESSFUL")
            .setMessage("""
                Attack Type: $attackType
                
                WHAT HAPPENED:
                $description
                
                REAL-WORLD CONSEQUENCES:
                ‚Ä¢ User security compromised through manipulation
                ‚Ä¢ Malware gains unauthorized access
                ‚Ä¢ Personal data at risk of theft
                ‚Ä¢ Device potentially fully compromised
                ‚Ä¢ User unaware they've been tricked
                
                PREVENTION:
                ‚Ä¢ Always verify unexpected warnings
                ‚Ä¢ Question urgent requests for action
                ‚Ä¢ Don't trust unsolicited security alerts
                ‚Ä¢ Verify update sources through official channels
                ‚Ä¢ Take time to think before granting permissions
                
                This demonstrates the power of social engineering!
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun updateStatus(message: String) {
        statusTextView.text = "${statusTextView.text}$message\n"
        statusTextView.post {
            val parent = statusTextView.parent as android.widget.ScrollView
            parent.fullScroll(android.widget.ScrollView.FOCUS_DOWN)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        activityScope.cancel()
    }
}
