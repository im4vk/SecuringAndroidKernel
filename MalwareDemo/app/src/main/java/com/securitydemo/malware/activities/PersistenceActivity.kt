package com.securitydemo.malware.activities

import android.app.AlertDialog
import android.content.Intent
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.provider.Settings
import android.widget.Button
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.securitydemo.malware.R
import com.securitydemo.malware.services.PersistenceManager
import kotlinx.coroutines.*

/**
 * SECURITY DEMO: Persistence Demonstration Activity
 * 
 * This activity demonstrates how malware achieves persistence:
 * - Multiple restart mechanisms
 * - Battery optimization bypass
 * - Component resurrection
 * - Self-healing capabilities
 * - System integration techniques
 * 
 * EDUCATIONAL PURPOSE ONLY - Shows real persistence techniques
 */
class PersistenceActivity : AppCompatActivity() {

    private lateinit var statusTextView: TextView
    private lateinit var initializePersistenceButton: Button
    private lateinit var testPersistenceButton: Button
    private lateinit var bypassBatteryOptButton: Button
    private lateinit var forceRestartButton: Button
    private lateinit var showReportButton: Button

    private lateinit var persistenceManager: PersistenceManager
    private val activityScope = CoroutineScope(Dispatchers.Main + SupervisorJob())

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_persistence)

        initializeViews()
        persistenceManager = PersistenceManager(this)
        
        showPersistenceWarning()
        checkPersistenceStatus()
    }

    private fun initializeViews() {
        statusTextView = findViewById(R.id.tv_persistence_status)
        initializePersistenceButton = findViewById(R.id.btn_initialize_persistence)
        testPersistenceButton = findViewById(R.id.btn_test_persistence)
        bypassBatteryOptButton = findViewById(R.id.btn_bypass_battery)
        forceRestartButton = findViewById(R.id.btn_force_restart)
        showReportButton = findViewById(R.id.btn_show_report)

        initializePersistenceButton.setOnClickListener { initializePersistence() }
        testPersistenceButton.setOnClickListener { testPersistenceMechanisms() }
        bypassBatteryOptButton.setOnClickListener { requestBatteryOptimizationBypass() }
        forceRestartButton.setOnClickListener { forceRestartComponents() }
        showReportButton.setOnClickListener { showPersistenceReport() }
    }

    private fun showPersistenceWarning() {
        AlertDialog.Builder(this)
            .setTitle("âš ï¸ Persistence Mechanisms Demo")
            .setMessage("""
                This demonstrates how malware achieves persistence:
                
                ðŸ”„ PERSISTENCE TECHNIQUES:
                â€¢ Multiple restart mechanisms
                â€¢ Boot receiver activation
                â€¢ Job scheduler exploitation
                â€¢ WorkManager abuse
                â€¢ Watchdog service monitoring
                â€¢ Component resurrection
                â€¢ Battery optimization bypass
                
                ðŸŽ¯ ATTACK OBJECTIVES:
                â€¢ Survive device reboots
                â€¢ Resist user termination attempts
                â€¢ Recover from system optimizations
                â€¢ Maintain long-term access
                â€¢ Avoid detection and removal
                
                âš ï¸ This is for educational purposes only!
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun checkPersistenceStatus() {
        updateStatus("ðŸ” PERSISTENCE SYSTEM ANALYSIS\n\n")
        
        activityScope.launch {
            val report = persistenceManager.getPersistenceReport()
            updateStatus(report)
            
            updateStatus("\nðŸ’¡ Ready to demonstrate persistence techniques")
        }
    }

    private fun initializePersistence() {
        updateStatus("ðŸš€ INITIALIZING ADVANCED PERSISTENCE...\n\n")
        
        activityScope.launch {
            try {
                updateStatus("Phase 1: Activating boot persistence mechanisms...")
                delay(1000)
                
                updateStatus("Phase 2: Setting up job scheduler persistence...")
                delay(1000)
                
                updateStatus("Phase 3: Configuring WorkManager persistence...")
                delay(1000)
                
                updateStatus("Phase 4: Deploying watchdog services...")
                delay(1000)
                
                updateStatus("Phase 5: Enabling component resurrection...")
                delay(1000)
                
                updateStatus("Phase 6: Setting up system integration...")
                delay(1000)
                
                // Initialize persistence manager
                persistenceManager.initializePersistence()
                
                updateStatus("âœ… PERSISTENCE INITIALIZATION COMPLETED!")
                updateStatus("ðŸŽ¯ Malware now has multiple survival mechanisms")
                updateStatus("ðŸ”„ Will survive reboots, app updates, and termination attempts")
                updateStatus("\nðŸš¨ MAXIMUM PERSISTENCE LEVEL ACHIEVED!")
                
                showPersistenceSuccess()
                
            } catch (e: Exception) {
                updateStatus("âŒ Persistence initialization error: ${e.message}")
            }
        }
    }

    private fun testPersistenceMechanisms() {
        updateStatus("ðŸ§ª TESTING PERSISTENCE MECHANISMS...\n\n")
        
        activityScope.launch {
            try {
                updateStatus("Test 1: Checking service auto-restart capability...")
                delay(1000)
                
                // Simulate service termination and restart
                updateStatus("â€¢ Terminating stealth service...")
                // Note: In real testing, services would be actually stopped and restarted
                delay(1500)
                
                updateStatus("â€¢ Watchdog detected termination")
                updateStatus("â€¢ Auto-restart mechanism triggered")
                updateStatus("âœ… Service successfully restarted")
                
                delay(1000)
                updateStatus("\nTest 2: Verifying boot receiver status...")
                delay(1000)
                updateStatus("âœ… Boot receiver is active and will restart malware on reboot")
                
                delay(1000)
                updateStatus("\nTest 3: Checking job scheduler persistence...")
                delay(1000)
                updateStatus("âœ… Multiple scheduled jobs active for periodic execution")
                
                delay(1000)
                updateStatus("\nTest 4: Testing component resurrection...")
                delay(1000)
                updateStatus("âœ… Self-healing mechanisms operational")
                
                updateStatus("\nðŸŽ¯ PERSISTENCE TEST RESULTS:")
                updateStatus("â€¢ Auto-restart: âœ… FUNCTIONAL")
                updateStatus("â€¢ Boot persistence: âœ… FUNCTIONAL") 
                updateStatus("â€¢ Job scheduler: âœ… FUNCTIONAL")
                updateStatus("â€¢ Component healing: âœ… FUNCTIONAL")
                updateStatus("â€¢ Watchdog monitoring: âœ… FUNCTIONAL")
                
                updateStatus("\nðŸš¨ PERSISTENCE MECHANISMS FULLY OPERATIONAL!")
                
            } catch (e: Exception) {
                updateStatus("âŒ Persistence test error: ${e.message}")
            }
        }
    }

    private fun requestBatteryOptimizationBypass() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            val powerManager = getSystemService(POWER_SERVICE) as android.os.PowerManager
            
            if (!powerManager.isIgnoringBatteryOptimizations(packageName)) {
                AlertDialog.Builder(this)
                    .setTitle("Battery Optimization Bypass")
                    .setMessage("""
                        This demonstrates how malware tries to bypass battery optimization:
                        
                        â€¢ Malware requests to be whitelisted from battery optimization
                        â€¢ This prevents the system from killing background services
                        â€¢ Real malware uses social engineering to trick users
                        â€¢ They claim it's for "enhanced performance" or "security"
                        
                        This is a critical persistence technique!
                    """.trimIndent())
                    .setPositiveButton("Show Settings") { _, _ ->
                        try {
                            val intent = Intent(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS).apply {
                                data = Uri.parse("package:$packageName")
                            }
                            startActivity(intent)
                        } catch (e: Exception) {
                            // Fallback to general battery optimization settings
                            val intent = Intent(Settings.ACTION_IGNORE_BATTERY_OPTIMIZATION_SETTINGS)
                            startActivity(intent)
                        }
                    }
                    .setNegativeButton("Cancel", null)
                    .show()
            } else {
                updateStatus("âœ… Battery optimization already bypassed!")
                updateStatus("ðŸŽ¯ Malware services protected from system termination")
            }
        } else {
            updateStatus("â„¹ï¸ Battery optimization not applicable on this Android version")
        }
    }

    private fun forceRestartComponents() {
        updateStatus("ðŸ”„ FORCE RESTARTING ALL MALWARE COMPONENTS...\n\n")
        
        activityScope.launch {
            try {
                updateStatus("Stopping all services...")
                delay(1000)
                
                updateStatus("Clearing component states...")
                delay(1000)
                
                updateStatus("Triggering resurrection mechanisms...")
                delay(1000)
                
                // Force restart through persistence manager
                persistenceManager.forceRestartAllComponents()
                
                updateStatus("Re-initializing persistence systems...")
                delay(1500)
                
                updateStatus("âœ… ALL COMPONENTS RESTARTED SUCCESSFULLY!")
                updateStatus("ðŸŽ¯ Malware has recovered from termination attempt")
                updateStatus("ðŸ”„ All services and persistence mechanisms restored")
                
                updateStatus("\nðŸš¨ TERMINATION RESISTANCE DEMONSTRATED!")
                updateStatus("Real malware uses these techniques to survive:")
                updateStatus("â€¢ Force-stop attempts by users")
                updateStatus("â€¢ System optimization processes")
                updateStatus("â€¢ Battery management systems")
                updateStatus("â€¢ Security software cleanup attempts")
                
            } catch (e: Exception) {
                updateStatus("âŒ Force restart error: ${e.message}")
            }
        }
    }

    private fun showPersistenceReport() {
        activityScope.launch {
            val report = persistenceManager.getPersistenceReport()
            
            AlertDialog.Builder(this@PersistenceActivity)
                .setTitle("ðŸ“Š Persistence Status Report")
                .setMessage(report)
                .setPositiveButton("Close", null)
                .setNeutralButton("Export") { _, _ ->
                    // In a real implementation, this would export the report
                    updateStatus("ðŸ“„ Persistence report exported")
                }
                .show()
        }
    }

    private fun showPersistenceSuccess() {
        AlertDialog.Builder(this)
            .setTitle("ðŸŽ¯ PERSISTENCE ACTIVATED")
            .setMessage("""
                Advanced persistence mechanisms are now active!
                
                SURVIVAL CAPABILITIES:
                â€¢ Automatic restart after termination
                â€¢ Recovery from system reboots
                â€¢ Resistance to battery optimization
                â€¢ Self-healing when components disabled
                â€¢ Multiple redundant restart mechanisms
                â€¢ System integration for camouflage
                
                ATTACK SCENARIO:
                â€¢ User tries to force-stop the app: âœ… Auto-restarts
                â€¢ Device reboots: âœ… Automatically starts on boot
                â€¢ System kills background services: âœ… Watchdog restarts them
                â€¢ User disables components: âœ… Self-healing re-enables them
                â€¢ Battery optimization kills services: âœ… Bypass mechanisms active
                
                The malware is now extremely difficult to remove!
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun updateStatus(message: String) {
        statusTextView.text = "${statusTextView.text}$message\n"
        statusTextView.post {
            val parent = statusTextView.parent as android.widget.ScrollView
            parent.fullScroll(android.widget.ScrollView.FOCUS_DOWN)
        }
    }

    override fun onResume() {
        super.onResume()
        // Update status when returning to activity
        activityScope.launch {
            delay(500)
            checkPersistenceStatus()
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        activityScope.cancel()
    }
}
